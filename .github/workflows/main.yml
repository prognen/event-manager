name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  static-analysis:
    runs-on: ubuntu-latest
    continue-on-error: false
    env:
      PYTHONPATH: ${{ github.workspace }}/src

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"  
          
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --with dev
          poetry run pip install flake8 mypy radon
          poetry run pip install opentelemetry-api opentelemetry-sdk \
          opentelemetry-instrumentation-fastapi opentelemetry-instrumentation-requests \
          opentelemetry-exporter-otlp opentelemetry.instrumentation.httpx

      - name: Run Flake8 (style + complexity)
        run: |
          echo "Running Flake8..."
          poetry run flake8 src --max-complexity 10

      - name: Run Mypy (type checking)
        run: |
          echo "Running Mypy..."
          poetry run mypy src --disable-error-code=unused-ignore

      - name: Run Radon (Cyclomatic + Halstead)
        run: |
          echo "Cyclomatic Complexity check:"
          poetry run radon cc src -a -nc
          echo "Halstead Metrics:"
          poetry run radon hal src

  unit-tests:
    needs: static-analysis
    runs-on: ubuntu-latest
    continue-on-error: false
    env:
      PYTHONPATH: ${{ github.workspace }}/src

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user -d test_db"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --with dev
          poetry run pip install allure-pytest
          poetry run pip install opentelemetry-api opentelemetry-sdk \
          opentelemetry-instrumentation-fastapi opentelemetry-instrumentation-requests \
          opentelemetry-exporter-otlp opentelemetry.instrumentation.httpx

      - name: Create directories for test results
        run: |
          mkdir -p allure-results/unit
          mkdir -p test-reports

      - name: Run unit tests
        run: |
          poetry run pytest tests/unit/ -v \
            --alluredir=allure-results/unit \
            --junitxml=test-reports/unit-tests.xml
        env:
          DATABASE_URL: postgresql+asyncpg://test_user:test_password@localhost:5432/test_db
          TEST_ENV: unit

      - name: Ensure Allure unit results exist
        run: |
          if [ ! -d "allure-results/unit" ] || [ -z "$(ls -A allure-results/unit)" ]; then
            echo '{
              "name": "Unit tests skipped",
              "status": "skipped",
              "stage": "finished",
              "steps": [],
              "labels": [{"name":"suite","value":"Unit"}]
            }' > allure-results/unit/skipped-unit.json
          fi

      - name: Upload unit test results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            allure-results/unit/
            test-reports/unit-tests.xml
        if: always()
  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    if: always()
    env:
      PYTHONPATH: ${{ github.workspace }}/src

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user -d test_db"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --with dev
          poetry run pip install allure-pytest
          poetry run pip install opentelemetry-api opentelemetry-sdk \
          opentelemetry-instrumentation-fastapi opentelemetry-instrumentation-requests \
          opentelemetry-exporter-otlp opentelemetry.instrumentation.httpx

      - name: Create directories for test results
        run: |
          mkdir -p allure-results/integration
          mkdir -p test-reports
          mkdir -p tests/integration

      # ------------------------------
      # Step for skipped tests if unit tests failed
      # ------------------------------
      - name: Run skipped integration test (if unit tests failed)
        if: ${{ needs.unit-tests.result != 'success' }}
        run: |
          cat <<'EOF' > tests/integration/skipped_integration.py
          import pytest

          @pytest.mark.skip(reason='Unit tests failed, integration skipped')
          def test_skipped():
              pass
          EOF
          poetry run pytest tests/integration/skipped_integration.py -v \
            --alluredir=allure-results/integration \
            --junitxml=test-reports/integration-tests.xml
        env:
          DATABASE_URL: postgresql+asyncpg://test_user:test_password@localhost:5432/test_db
          TEST_ENV: integration

      # ------------------------------
      # Step for normal integration tests if unit tests passed
      # ------------------------------
      - name: Run integration tests
        if: ${{ needs.unit-tests.result == 'success' }}
        run: |
          poetry run pytest tests/integration/ -v \
            --alluredir=allure-results/integration \
            --junitxml=test-reports/integration-tests.xml
        env:
          DATABASE_URL: postgresql+asyncpg://test_user:test_password@localhost:5432/test_db
          TEST_ENV: integration

      - name: Check if Allure results were generated
        run: |
          echo "Checking Allure results directory:"
          ls -la allure-results/integration/ || echo "No Allure results found"
          echo "Checking test reports directory:"
          ls -la test-reports/ || echo "No test reports found"

      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            allure-results/integration/
            test-reports/integration-tests.xml
        if: always()

  e2e-tests:
    runs-on: ubuntu-latest
    needs: integration-tests
    if: always()
    env:
      PYTHONPATH: ${{ github.workspace }}/src

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: egor
          POSTGRES_PASSWORD: egor
          POSTGRES_DB: mydb
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U egor -d mydb"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5
      mailhog:
        image: mailhog/mailhog:v1.0.1
        ports:
          - 1025:1025
          - 8025:8025

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --with dev --with e2e
          poetry run pip install allure-pytest pytest-bdd requests
          poetry run pip install opentelemetry-api opentelemetry-sdk \
          opentelemetry-instrumentation-fastapi opentelemetry-instrumentation-requests \
          opentelemetry-exporter-otlp opentelemetry.instrumentation.httpx

      - name: Create directories for test results
        run: |
          mkdir -p allure-results/e2e
          mkdir -p test-reports
          mkdir -p tests/e2e

      # ------------------------------------------------------------------
      # Пропускаем E2E-тесты, если integration-тесты не прошли.
      # Генерируем skipped-результат для отчёта.
      # ------------------------------------------------------------------
      - name: Run skipped e2e test (if integration tests failed)
        if: ${{ needs.integration-tests.result != 'success' }}
        run: |
          cat <<'EOF' > tests/e2e/skipped_e2e.py
          import pytest

          @pytest.mark.skip(reason='Integration tests failed, e2e skipped')
          def test_skipped():
              pass
          EOF
          poetry run pytest tests/e2e/skipped_e2e.py -v \
            --alluredir=allure-results/e2e \
            --junitxml=test-reports/e2e-tests.xml
        env:
          DATABASE_URL: postgresql+asyncpg://egor:egor@localhost:5432/mydb
          TEST_ENV: e2e

      # ------------------------------------------------------------------
      # Запускаем реальные E2E-тесты только если integration прошли.
      # ------------------------------------------------------------------
      - name: Initialize test database
        if: ${{ needs.integration-tests.result == 'success' }}
        run: |
          echo "Running DB init scripts..."
          for script in db-init/*.sql; do
            PGPASSWORD=egor psql -h localhost -U egor -d mydb -f "$script"
          done

      - name: Run FastAPI app in background
        if: ${{ needs.integration-tests.result == 'success' }}
        run: |
          nohup poetry run uvicorn src.main:app --host 0.0.0.0 --port 8000 &
          sleep 5

      - name: Run e2e tests & BDD tests
        if: ${{ needs.integration-tests.result == 'success' }}
        run: |
          poetry run pytest tests/e2e/ tests/steps/ -v \
            --alluredir=allure-results/e2e \
            --junitxml=test-reports/e2e-tests.xml
        env:
          DATABASE_URL: postgresql+asyncpg://egor:egor@localhost:5432/mydb
          BASE_URL: http://localhost:8000
          MAIL_HOST: localhost
          MAIL_PORT: 1025
          TEST_ENV: e2e
          BDD_USER_PASS: ${{ secrets.BDD_USER_PASS }}

      # ------------------------------------------------------------------
      # Откат хранилища: удаление тестовых данных из БД (всегда).
      # Требование 7: если свалился e2e этап — откатить хранилище.
      # ------------------------------------------------------------------
      - name: Rollback e2e test data in database
        if: always()
        run: |
          echo "Rolling back e2e test data..."
          PGPASSWORD=egor psql -h localhost -U egor -d mydb -c "
            DELETE FROM event_db.users_event
            WHERE users_id IN (
              SELECT id FROM event_db.users
              WHERE login LIKE 'mvp_test_%'
                 OR login LIKE 'techuser_%'
            );
            DELETE FROM event_db.users
            WHERE login LIKE 'mvp_test_%'
               OR login LIKE 'techuser_%';
          " || echo "DB rollback skipped (DB not initialized)"

      # ------------------------------------------------------------------
      # Вычитывание сообщений из MailHog (всегда, требование 8).
      # ------------------------------------------------------------------
      - name: Drain MailHog inbox (always)
        if: always()
        run: |
          echo "Checking MailHog messages..."
          curl -sf http://localhost:8025/api/v2/messages \
            | jq '.items | length' \
            || echo "MailHog not available"

      - name: Dump MailHog inbox content (always)
        if: always()
        run: |
          curl -sf http://localhost:8025/api/v2/messages \
            | jq '.items[] | {subject: .Content.Headers.Subject, body: .Content.Body}' \
            || echo "No messages or MailHog not available"

      - name: Ensure Allure e2e results exist
        if: always()
        run: |
          if [ ! -d "allure-results/e2e" ] || [ -z "$(ls -A allure-results/e2e)" ]; then
            echo '{
              "name": "E2E tests skipped",
              "status": "skipped",
              "stage": "finished",
              "steps": [],
              "labels": [{"name":"suite","value":"E2E"}]
            }' > allure-results/e2e/skipped-e2e.json
          fi

      - name: Upload e2e test results
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            allure-results/e2e/
            test-reports/e2e-tests.xml
        if: always()

  benchmark-tests:
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --with dev
          poetry run pip install httpx

      - name: Create Docker networks
        run: |
          docker network create my_network 2>/dev/null || true
          docker network create monitoring 2>/dev/null || true

      - name: Start Postgres and FastAPI app
        run: |
          ENABLE_TRACING=0 LOG_LEVEL=info docker compose up -d db app
          sleep 15
          curl -sf http://localhost:8000/health || (docker compose logs app; exit 1)

      - name: Run FastAPI benchmark (60 sec quick run)
        run: |
          mkdir -p results
          poetry run python benchmark/benchmark_runner.py \
            --base-url http://localhost:8000 \
            --output-dir results \
            --framework fastapi \
            --quick

      - name: Verify benchmark results
        run: |
          ls -la results/
          test -n "$(ls -A results/*.json 2>/dev/null)" || exit 1

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: results/

  allure-report:
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, benchmark-tests]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore Allure history from gh-pages
        continue-on-error: true
        run: |
          git fetch origin gh-pages --depth=1 2>/dev/null || echo "gh-pages branch does not exist yet (first run)"
          git checkout FETCH_HEAD -- history 2>/dev/null || echo "No history to restore"

      - name: Install Allure
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre
          wget -q https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -zxvf allure-2.27.0.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts

      - name: Prepare Allure results directory
        run: |
          mkdir -p merged-allure-results

          # Копируем историю из предыдущего отчета (если есть)
          if [ -d "history" ]; then
            echo "Copying existing history..."
            cp -r history merged-allure-results/
            echo "History files copied: $(find merged-allure-results/history -name '*.json' | wc -l)"
          else
            echo "No existing history found - starting fresh"
          fi

          # Копируем новые JSON файлы результатов (unit/integration/e2e)
          find downloaded-artifacts -name "*.json" -exec cp {} merged-allure-results/ \;

          # Копируем benchmark TXT файлы в формат Allure
          if [ -d "downloaded-artifacts/benchmark" ]; then
            echo "Copying benchmark TXT files..."
            for f in downloaded-artifacts/benchmark/*.txt; do
              # Меняем расширение на .json, чтобы Allure смог обработать (или просто копируем как есть)
              cp "$f" merged-allure-results/
            done
            echo "Benchmark files copied: $(ls merged-allure-results/*.txt | wc -l)"
          else
            echo "No benchmark files found"
          fi

          echo "Total files in merged-allure-results: $(ls merged-allure-results | wc -l)"


      - name: Generate Allure Report with history
        run: |
          json_count=$(find merged-allure-results -name '*.json' | wc -l)
          echo "Total JSON files for report: $json_count"
          
          if [ "$json_count" -gt 0 ]; then
            echo "Generating Allure report with trends..."
            allure generate merged-allure-results/ -o allure-report --clean
            
            # Проверяем что история создалась
            if [ -d "allure-report/history" ]; then
              echo "History directory created successfully"
              echo "History items: $(ls allure-report/history/ | wc -l)"
            else
              echo "Warning: No history directory created"
            fi
          else
            mkdir -p allure-report
            echo "<html><body><h1>Test Reports</h1><p>No test results available.</p></body></html>" > allure-report/index.html
          fi

      - name: Add .nojekyll file
        run: |
          touch allure-report/.nojekyll
          echo "GitHub Pages configuration added"

      - name: Deploy to GitHub Pages with history
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          keep_files: true


  # test-metrics:
  #   runs-on: ubuntu-latest
  #   needs: [unit-tests, integration-tests, e2e-tests]
  #   if: always()
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Download all test results
  #       uses: actions/download-artifact@v4
  #       with:
  #         path: downloaded-artifacts

  #     - name: Generate test metrics
  #       run: |
  #         # Создаем простой файл с метриками для трендов
  #         mkdir -p test-metrics
          
  #         # Считаем результаты тестов
  #         echo "Generating test metrics..."
          
  #         # Можно добавить скрипт для анализа JUnit XML файлов
  #         cat > test-metrics/metrics.json << 'EOF'
  #         {
  #           "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  #           "commit": "${{ github.sha }}",
  #           "run_id": "${{ github.run_id }}"
  #         }
  #         EOF
          
  #     - name: Upload metrics
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: test-metrics
  #         path: test-metrics
  #       if: always()